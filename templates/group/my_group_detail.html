{% extends 'base.html' %}
{% load static %}
{% load crispy_forms_tags %}

{% block title %}{{ group }}{% endblock %}

{% block head %}
  {# base.html allaqachon Bootstrap 5 ni ulagan, shu bois qayta ulamaymiz #}
  <script src="{% static 'js/form-validation.js' %}" defer></script>
  <style>
    /* Katta va qulay checkbox (OS ko'rinishini saqlagan holda) */
    .attendance-toggle { transform: scale(1.25); cursor: pointer; }
    .attendance-cell { text-align:center; vertical-align: middle; }
    .name-cell { min-width: 260px; }

    /* Jadval ko'rinishi */
    .legend { font-size: .9rem; }
    .table thead th { white-space: nowrap; }
  </style>
{% endblock %}

{% block content %}
  {# Xabarlar (Bootstrap 5) #}
  {% if messages %}
    <div class="position-fixed top-0 start-50 translate-middle-x p-3" style="z-index:1080;">
      {% for message in messages %}
        <div class="alert alert-{{ message.tags|default:'info' }} alert-dismissible fade show shadow-sm mb-2" role="alert">
          <strong>{{ message.tags|title }}:</strong> {{ message }}
          <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
      {% endfor %}
    </div>
  {% endif %}

  <div class="d-flex flex-column flex-md-row justify-content-between align-items-md-center gap-3 mb-3">
    <h1 class="h3 mb-0">{{ group }}</h1>
    <div class="legend text-secondary">
      <span class="me-3"><i class="bi bi-square"></i> belgilanmagan — <strong>bor</strong></span>
      <span><i class="bi bi-check-square"></i> belgilangan — <strong>yo'q</strong></span>
    </div>
  </div>

  {# Bulk actions (har bir para bo'yicha) #}
  <div class="d-flex flex-wrap gap-2 mb-3">
    {% if para1 == 'True' %}
      <div class="btn-group btn-group-sm" role="group" aria-label="Para 1">
        <button type="button" class="btn btn-outline-success" data-bulk="para1" data-mode="present">1‑para: Hamma bor</button>
        <button type="button" class="btn btn-outline-danger" data-bulk="para1" data-mode="absent">1‑para: Hamma yo'q</button>
      </div>
    {% endif %}
    {% if para2 == 'True' %}
      <div class="btn-group btn-group-sm" role="group" aria-label="Para 2">
        <button type="button" class="btn btn-outline-success" data-bulk="para2" data-mode="present">2‑para: Hamma bor</button>
        <button type="button" class="btn btn-outline-danger" data-bulk="para2" data-mode="absent">2‑para: Hamma yo'q</button>
      </div>
    {% endif %}
    {% if para3 == 'True' %}
      <div class="btn-group btn-group-sm" role="group" aria-label="Para 3">
        <button type="button" class="btn btn-outline-success" data-bulk="para3" data-mode="present">3‑para: Hamma bor</button>
        <button type="button" class="btn btn-outline-danger" data-bulk="para3" data-mode="absent">3‑para: Hamma yo'q</button>
      </div>
    {% endif %}
  </div>

  <form id="attendance-form" method="POST" action="{% url 'group_attendance' pk=group.id %}">
    {% csrf_token %}

    <div class="table-responsive">
      <table class="table table-hover align-middle" id="attendanceTable">
        <thead class="table-secondary">
          <tr>
            <th scope="col">№</th>
            <th scope="col">Ism Familiya Sharif</th>
            <th scope="col" class="text-center">1‑Para</th>
            <th scope="col" class="text-center">2‑Para</th>
            <th scope="col" class="text-center">3‑Para</th>
          </tr>
        </thead>
        <tbody>
          {% for student in students %}
            <tr>
              <td>{{ forloop.counter }}</td>
              <td class="name-cell">{{ student.student_last_name }} {{ student.student_name }} {{ student.student_father_name }}</td>

              {# 1‑para #}
              <td class="attendance-cell">
                {% if para1 == 'True' %}
                  <input type="hidden" name="para1_{{ student.id }}" value="+">
                  <input class="form-check-input attendance-toggle" name="para1_{{ student.id }}" type="checkbox" value="-" aria-label="1‑para: yo'q (belgilansa)" />
                {% else %}
                  <input type="hidden" name="para1_{{ student.id }}" value="">
                  <input class="form-check-input" name="para1_{{ student.id }}" type="checkbox" value="" disabled title="1‑para faol emas" />
                {% endif %}
              </td>

              {# 2‑para #}
              <td class="attendance-cell">
                {% if para2 == 'True' %}
                  <input type="hidden" name="para2_{{ student.id }}" value="+">
                  <input class="form-check-input attendance-toggle" name="para2_{{ student.id }}" type="checkbox" value="-" aria-label="2‑para: yo'q (belgilansa)" />
                {% else %}
                  <input type="hidden" name="para2_{{ student.id }}" value="">
                  <input class="form-check-input" name="para2_{{ student.id }}" type="checkbox" value="" disabled title="2‑para faol emas" />
                {% endif %}
              </td>

              {# 3‑para #}
              <td class="attendance-cell">
                {% if para3 == 'True' %}
                  <input type="hidden" name="para3_{{ student.id }}" value="+">
                  <input class="form-check-input attendance-toggle" name="para3_{{ student.id }}" type="checkbox" value="-" aria-label="3‑para: yo'q (belgilansa)" />
                {% else %}
                  <input type="hidden" name="para3_{{ student.id }}" value="">
                  <input class="form-check-input" name="para3_{{ student.id }}" type="checkbox" value="" disabled title="3‑para faol emas" />
                {% endif %}
              </td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <div class="d-flex justify-content-end mt-3">
      <input class="btn btn-success" type="submit" value="Saqlash">
    </div>
  </form>

  <div id="error-message" class="text-danger mt-2"></div>
{% endblock %}

{% block extra_js %}
<script>
  (function(){
    // Alertlarni 5 soniyada yopish
    const alerts = document.querySelectorAll('.alert');
    if(alerts.length){
      setTimeout(() => {
        alerts.forEach(a => {
          const inst = bootstrap.Alert.getOrCreateInstance(a);
          inst.close();
        });
      }, 5000);
    }

    // Bulk actions: para bo'yicha hamma bor/yo'q
    document.querySelectorAll('[data-bulk]').forEach(btn => {
      btn.addEventListener('click', function(){
        const para = this.getAttribute('data-bulk');
        const mode = this.getAttribute('data-mode'); // present | absent
        const selector = `input[name^="${para}_"]:not([disabled])`;
        document.querySelectorAll(selector).forEach(chk => {
          if (chk.type === 'checkbox') {
            chk.checked = (mode === 'absent');
          }
        });
        updateRowHighlights();
      });
    });

    // Qatorlarni holatiga ko'ra yoritish
    function updateRowHighlights(){
      document.querySelectorAll('#attendanceTable tbody tr').forEach(tr => {
        const anyAbsent = Array.from(tr.querySelectorAll('.attendance-toggle')).some(c => c.checked);
        tr.classList.toggle('table-danger', anyAbsent);
      });
    }

    document.querySelectorAll('.attendance-toggle').forEach(chk => {
      chk.addEventListener('change', updateRowHighlights);
    });

    updateRowHighlights();
  })();
</script>
{% endblock %}
