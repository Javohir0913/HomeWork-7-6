{% extends 'base.html' %}
{% load crispy_forms_tags %}

{% block title %}My Group{% endblock %}

{% block content %}
  {# Bootstrap 5 formatdagi xabarlar (dismissible + auto-hide) #}
  {% if messages %}
    <div class="position-fixed top-0 start-50 translate-middle-x p-3" style="z-index:1080;">
      {% for message in messages %}
        <div class="alert alert-{{ message.tags|default:'info' }} alert-dismissible fade show shadow-sm mb-2" role="alert">
          <strong>{{ message.tags|title }}:</strong> {{ message }}
          <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
      {% endfor %}
    </div>
  {% endif %}

  <div class="d-flex flex-column flex-md-row align-items-md-center justify-content-between gap-3 mb-3">
    <h1 class="h3 mb-0">Guruhlar</h1>
    <div class="d-flex gap-2 w-100 w-md-auto">
      <input id="searchGroups" type="search" class="form-control" placeholder="Qidirish: guruh nomi..." aria-label="Qidirish" />
    </div>
  </div>

  <div class="table-responsive">
    <table class="table table-hover align-middle" id="groupsTable">
      <thead class="table-secondary">
        <tr>
          <th scope="col">Guruh</th>
          <th scope="col" class="text-center">Odamlar</th>
          {% if user.is_superuser %}
            <th scope="col" class="text-center">Excel</th>
          {% endif %}
        </tr>
      </thead>
      <tbody>
        {% for info in all_info %}
          <tr>
            <td>
              <a class="text-decoration-none" href="{% url 'group_attendance' info.group.id %}">
                <i class="bi bi-people me-1"></i>{{ info.group }}
              </a>
            </td>
            <td class="text-center">
              <span class="badge rounded-pill text-bg-primary">{{ info.count_people }}</span>
            </td>
            {% if user.is_superuser %}
              <td class="text-center">
                <a class="btn btn-sm btn-outline-success" href="{% url 'export_attendance_to_excel' info.group.id %}">
                  <i class="bi bi-filetype-xlsx me-1"></i>Excel
                </a>
              </td>
            {% endif %}
          </tr>
        {% empty %}
          <tr>
            <td colspan="{% if user.is_superuser %}3{% else %}2{% endif %}" class="text-center text-secondary py-4">Guruhlar topilmadi.</td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
{% endblock %}

{% block extra_js %}
<script>
  (function(){
    // Qidiruv filtri
    const input = document.getElementById('searchGroups');
    const table = document.getElementById('groupsTable');
    if(input && table){
      input.addEventListener('input', function(){
        const q = this.value.trim().toLowerCase();
        const rows = Array.from(table.tBodies[0].rows);
        rows.forEach(tr => {
          const txt = (tr.textContent || tr.innerText || '').toLowerCase();
          tr.style.display = txt.includes(q) ? '' : 'none';
        });
      });
    }

    // Alertlarni 5 soniyada yopish (Bootstrap 5 bilan)
    const alerts = document.querySelectorAll('.alert');
    if(alerts.length){
      setTimeout(() => {
        alerts.forEach(a => {
          if (a.classList.contains('show')) {
            const bsAlert = bootstrap.Alert.getOrCreateInstance(a);
            bsAlert.close();
          }
        });
      }, 5000);
    }
  })();
</script>
{% endblock %}
